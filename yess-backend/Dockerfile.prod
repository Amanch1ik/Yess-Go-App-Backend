# -----------------------------
# üêç Dockerfile.prod ‚Äî Yess Backend
# -----------------------------

FROM python:3.9-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ + wait-for-it
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    bash \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º wait-for-it ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RAW URL
RUN curl -sSL https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh \
    -o /usr/local/bin/wait-for-it \
    && chmod +x /usr/local/bin/wait-for-it

# –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
COPY . .

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8000

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ (–∂–¥—ë–º PostgreSQL ‚Üí –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Üí uvicorn)
CMD ["bash", "-c", "wait-for-it postgres:5432 -t 60 && alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"]
